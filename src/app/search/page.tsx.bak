// src/app/search/page.tsx
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import useUserLocation from "@/hooks/useUserLocation";
import useAuth from "@/hooks/useAuth";
import {
  openStatusStream,
  sendMessage,
  startSession,
  type Origin,
  type Plan,
} from "@/api/search/ai";

type StatusEvent =
  | { step: string; message?: string; plan?: Plan; ts?: number; [k: string]: any }
  | Record<string, any>;

export default function SearchPage() {
  // 1) í† í° & ìœ„ì¹˜
  const { getUserToken } = useAuth();
  const token = getUserToken();
  const { location, error: locError } = useUserLocation();

  // 2) UI ìƒíƒœ
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [input, setInput] = useState("");
  const [plan, setPlan] = useState<Plan | null>(null);
  const [events, setEvents] = useState<StatusEvent[]>([]);
  const esRef = useRef<EventSource | null>(null);
  const [starting, setStarting] = useState(false);
  const [sending, setSending] = useState(false);

  // 3) origin ë³€í™˜
  const origin: Origin | undefined = useMemo(() => {
    if (!location) return undefined;
    return { mapX: location.lng, mapY: location.lat };
  }, [location]);

  // 4) ì„¸ì…˜ ì‹œì‘ (í† í°+ìœ„ì¹˜ ì¤€ë¹„ë˜ë©´ 1íšŒ)
  useEffect(() => {
    if (!token) return;
    if (!origin) return;
    if (sessionId) return;
    (async () => {
      try {
        setStarting(true);
        const res = await startSession(
          {
            origin,
            days: 2,
            mode: "walk",
            tags: ["ë§›ì§‘", "íë§"], // ì´ˆê¸° íƒœê·¸(ì˜µì…˜)
          },
          token
        );
        setSessionId(res.session_id);
      } catch (e: any) {
        console.error("startSession failed:", e);
        alert(`ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ${e?.message || e}`);
      } finally {
        setStarting(false);
      }
    })();
  }, [token, origin, sessionId]);

  // 5) SSE ì—°ê²° (ì„¸ì…˜ ìƒê¸°ë©´ ì—°ê²°)
  useEffect(() => {
    if (!token || !sessionId) return;
    // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ë‹«ê¸°
    if (esRef.current) {
      esRef.current.close();
      esRef.current = null;
    }
    const es = openStatusStream(sessionId, token);
    esRef.current = es;

    es.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);
        setEvents((prev) => [...prev, data]);

        // ê²°ê³¼ í”Œëœ ë„ì°© ì‹œ ë³´ê´€
        if (data.step === "RESULT" && data.plan) {
          setPlan(data.plan as Plan);
        }
        if (data.step === "DONE") {
          // í•„ìš” ì‹œ ìë™ ìŠ¤í¬ë¡¤/ì•ŒëŒ ë“±
        }
      } catch (e) {
        console.warn("SSE parse error:", e);
      }
    };
    es.onerror = (e) => {
      console.warn("SSE error:", e);
    };

    return () => {
      es.close();
      esRef.current = null;
    };
  }, [token, sessionId]);

  // 6) ë©”ì‹œì§€ ì „ì†¡
  const onSend = async () => {
    if (!token || !sessionId) {
      alert("ì„¸ì…˜ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.");
      return;
    }
    const message = input.trim();
    if (!message) return;

    setSending(true);
    try {
      const res = await sendMessage(
        sessionId,
        { message, origin }, // ì›í•œë‹¤ë©´ days/mode/tagsë„ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆìŒ
        token
      );
      // ì‘ë‹µ ì¦‰ì‹œ ê²°ê³¼ í”Œëœë„ ë°˜ì˜ (SSE RESULTì™€ ì¤‘ë³µì¼ ìˆ˜ ìˆì§€ë§Œ ì‚¬ìš©ì ë°˜ì‘ ë¹ ë¥´ê²Œ)
      setPlan(res.plan);
      setEvents((prev) => [
        ...prev,
        { step: "CLIENT", message: `ì§ˆë¬¸: ${message}`, ts: Date.now() },
        { step: res.status?.step ?? "STATUS", message: res.status?.message, ts: Date.now() },
      ]);
      setInput("");
    } catch (e: any) {
      console.error(e);
      alert(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${e?.message || e}`);
    } finally {
      setSending(false);
    }
  };

  return (
    <main style={{ padding: 24, maxWidth: 1000, margin: "0 auto" }}>
      <h1 style={{ fontSize: 24, fontWeight: 700, marginBottom: 12 }}>
        ğŸ” ì—¬í–‰ ê²€ìƒ‰ (ë¡œì»¬ í…ŒìŠ¤íŠ¸)
      </h1>

      {/* í† í°/ìœ„ì¹˜ ìƒíƒœ */}
      <section
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: 12,
          marginBottom: 16,
        }}
      >
        <div
          style={{
            padding: 12,
            border: "1px solid #eee",
            borderRadius: 8,
            background: "#fafafa",
          }}
        >
          <div>
            <b>Auth</b>
          </div>
          <div style={{ fontSize: 13 }}>
            {token ? "âœ… í† í° ìˆìŒ" : "âŒ í† í° ì—†ìŒ (ë¡œê·¸ì¸ í•„ìš”)"}
          </div>
        </div>

        <div
          style={{
            padding: 12,
            border: "1px solid #eee",
            borderRadius: 8,
            background: "#fafafa",
          }}
        >
          <div>
            <b>Location</b>
          </div>
          <div style={{ fontSize: 13 }}>
            {location
              ? `âœ… ${location.lat.toFixed(5)}, ${location.lng.toFixed(
                  5
                )} (by ${location.source})`
              : locError
              ? `âŒ ${locError}`
              : "â³ ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."}
          </div>
        </div>
      </section>

      {/* ì„¸ì…˜/ì…ë ¥ */}
      <section
        style={{
          display: "flex",
          gap: 8,
          alignItems: "center",
          marginBottom: 16,
        }}
      >
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder='ì˜ˆ) "í™ëŒ€ì—ì„œ 2ì¼ ì½”ìŠ¤ë¡œ ë§›ì§‘+ë³¼ê±°ë¦¬ ìœ„ì£¼ë¡œ ì¶”ì²œ"'
          style={{
            flex: 1,
            padding: "10px 12px",
            border: "1px solid #ddd",
            borderRadius: 8,
            outline: "none",
          }}
          onKeyDown={(e) => {
            if (e.key === "Enter") onSend();
          }}
          disabled={!sessionId || sending}
        />
        <button
          onClick={onSend}
          disabled={!sessionId || sending}
          style={{
            padding: "10px 16px",
            borderRadius: 8,
            border: "1px solid #111",
            background: "#111",
            color: "#fff",
            cursor: "pointer",
            opacity: !sessionId || sending ? 0.6 : 1,
          }}
        >
          {sending ? "ì „ì†¡ ì¤‘..." : "ì „ì†¡"}
        </button>
      </section>

      {/* ì„¸ì…˜ ì •ë³´ */}
      <section style={{ marginBottom: 16 }}>
        <div style={{ fontSize: 13, color: "#666" }}>
          ì„¸ì…˜:{" "}
          {starting
            ? "ì„¸ì…˜ ì‹œì‘ ì¤‘..."
            : sessionId
            ? `âœ… ${sessionId}`
            : "â³ ìœ„ì¹˜/í† í° ì¤€ë¹„ ì¤‘..."}
        </div>
      </section>

      {/* ìƒíƒœ ë¡œê·¸ (SSE) */}
      <section style={{ marginBottom: 20 }}>
        <h2 style={{ fontSize: 18, fontWeight: 600, marginBottom: 8 }}>
          ì‹¤ì‹œê°„ ìƒíƒœ ë¡œê·¸
        </h2>
        <div
          style={{
            border: "1px solid #eee",
            borderRadius: 8,
            padding: 12,
            maxHeight: 200,
            overflow: "auto",
            fontSize: 13,
            background: "#fff",
          }}
        >
          {events.length === 0 ? (
            <div style={{ color: "#aaa" }}>ì•„ì§ ì´ë²¤íŠ¸ê°€ ì—†ì–´ìš”.</div>
          ) : (
            events.map((ev, idx) => (
              <div key={idx} style={{ marginBottom: 6 }}>
                <code>
                  {typeof ev === "string"
                    ? ev
                    : JSON.stringify(ev, null, 0)}
                </code>
              </div>
            ))
          )}
        </div>
      </section>

      {/* ê²°ê³¼ ë Œë”ë§ */}
      <section>
        <h2 style={{ fontSize: 18, fontWeight: 600, marginBottom: 8 }}>
          ê²°ê³¼ (Plan)
        </h2>
        {!plan ? (
          <div style={{ color: "#aaa" }}>ì•„ì§ ê²°ê³¼ê°€ ì—†ì–´ìš”. ì§ˆë¬¸ì„ ì…ë ¥í•´ë³´ì„¸ìš”.</div>
        ) : (
          <>
            {/* ìš”ì•½ ì¹´ë“œ */}
            <div
              style={{
                border: "1px solid #ddd",
                borderRadius: 10,
                padding: 16,
                marginBottom: 16,
                background: "#fafafa",
              }}
            >
              <div style={{ fontSize: 20, fontWeight: 700 }}>{plan.title}</div>
              <div style={{ color: "#555", marginTop: 4 }}>{plan.subtitle}</div>
              {plan.theme && plan.theme.length > 0 && (
                <div style={{ marginTop: 8, fontSize: 13 }}>
                  <b>Theme:</b> {plan.theme.join(", ")}
                </div>
              )}
              {plan.keywords && plan.keywords.length > 0 && (
                <div style={{ marginTop: 4, fontSize: 13 }}>
                  <b>Keywords:</b> {plan.keywords.join(", ")}
                </div>
              )}
              {plan.summary && (
                <div style={{ marginTop: 8, fontSize: 14 }}>{plan.summary}</div>
              )}
            </div>

            {/* ì¼ìë³„ */}
            {plan.days?.map((d) => (
              <div key={d.day} style={{ marginBottom: 16 }}>
                <div style={{ fontWeight: 700, marginBottom: 6 }}>
                  Day {d.day}
                </div>
                <div style={{ display: "grid", gap: 8 }}>
                  {d.segments.map((s, i) => (
                    <div
                      key={i}
                      style={{
                        border: "1px solid #eee",
                        borderRadius: 8,
                        padding: 12,
                        background: "#fff",
                      }}
                    >
                      <div style={{ fontSize: 14, marginBottom: 4 }}>
                        <b>[{s.type}]</b> {s.title}
                      </div>
                      <div style={{ fontSize: 13, color: "#555" }}>{s.desc}</div>
                      <div style={{ fontSize: 12, color: "#777", marginTop: 4 }}>
                        ì´ìœ : {s.reason}
                      </div>
                      <div style={{ fontSize: 12, color: "#777", marginTop: 4 }}>
                        ì¢Œí‘œ: {s.coords?.mapx}, {s.coords?.mapy} | ì œê³µ:{" "}
                        {s.provider} |{" "}
                        <a href={s.source} target="_blank" rel="noreferrer">
                          ì¶œì²˜
                        </a>
                      </div>
                      {s.images?.length ? (
                        <div style={{ marginTop: 8, display: "flex", gap: 8 }}>
                          {s.images.slice(0, 3).map((img, k) => (
                            <img
                              key={k}
                              src={img}
                              alt="img"
                              width={100}
                              height={70}
                              style={{
                                objectFit: "cover",
                                borderRadius: 6,
                                border: "1px solid #eee",
                              }}
                            />
                          ))}
                        </div>
                      ) : null}
                    </div>
                  ))}
                </div>
              </div>
            ))}

            {/* ì›ë³¸ JSON ë³´ê¸° */}
            <details style={{ marginTop: 12 }}>
              <summary>ì›ë³¸ JSON</summary>
              <pre
                style={{
                  marginTop: 8,
                  border: "1px solid #eee",
                  borderRadius: 8,
                  padding: 12,
                  background: "#fff",
                  fontSize: 12,
                  overflow: "auto",
                }}
              >
                {JSON.stringify(plan, null, 2)}
              </pre>
            </details>
          </>
        )}
      </section>
    </main>
  );
}
